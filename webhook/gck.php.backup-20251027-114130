<?php
/**
 * Вебхук для GCK
 * URL: https://ваш-домен.ru/admin_panel/webhook/gck.php
 */

require_once '../config/database.php';
require_once '../lidtracker/classes/WebhookReceiver.php';

/**
 * Класс обработчика вебхуков GCK
 * Формат данных согласно официальной документации GCK
 */
class GckReceiver extends WebhookReceiver {

    protected function extractPhone($data) {
        // GCK: phones[] - массив телефонов, берем первый
        if (isset($data['phones']) && is_array($data['phones']) && !empty($data['phones'])) {
            return $data['phones'][0];
        }
        // Fallback на прямое поле phone
        if (isset($data['phone'])) {
            return $data['phone'];
        }
        return null;
    }

    protected function mapFields($data) {
        $mapped = [];

        // Контактные данные
        $mapped['name'] = $data['name'] ?? $data['fio'] ?? null;

        // Email из массива mails[]
        if (isset($data['mails']) && is_array($data['mails']) && !empty($data['mails'])) {
            $mapped['email'] = $data['mails'][0];
        } else {
            $mapped['email'] = $data['email'] ?? null;
        }

        $mapped['external_id'] = $data['vid'] ?? null;

        // UTM метки из массива utm[]
        if (isset($data['utm']) && is_array($data['utm'])) {
            $utm = $data['utm'];
            $mapped['utm_source'] = $utm['utm_source'] ?? null;
            $mapped['utm_medium'] = $utm['utm_medium'] ?? null;
            $mapped['utm_campaign'] = $utm['utm_campaign'] ?? null;
            $mapped['utm_content'] = $utm['utm_content'] ?? null;
            $mapped['utm_term'] = $utm['utm_term'] ?? null;
        } else {
            // Fallback на корневые поля (для обратной совместимости)
            $mapped['utm_source'] = $data['utm_source'] ?? null;
            $mapped['utm_medium'] = $data['utm_medium'] ?? null;
            $mapped['utm_campaign'] = $data['utm_campaign'] ?? null;
            $mapped['utm_content'] = $data['utm_content'] ?? null;
            $mapped['utm_term'] = $data['utm_term'] ?? null;
        }

        // Дополнительные данные GCK
        $mapped['ip_address'] = $data['ip'] ?? null;
        $mapped['user_agent'] = $data['browser'] ?? null;

        // Геолокация (полная: город, регион, страна)
        $geoparts = array_filter([
            $data['city'] ?? null,
            $data['region'] ?? null,
            $data['country'] ?? null
        ]);
        $mapped['geolocation'] = !empty($geoparts) ? implode(', ', $geoparts) : null;

        $mapped['referer'] = $data['ref'] ?? $data['referer'] ?? null;
        $mapped['page_url'] = $data['page'] ?? $data['url'] ?? null;

        return $mapped;
    }
}

// ============================================
// Обработка входящего запроса
// ============================================

header('Content-Type: application/json; charset=utf-8');

try {
    // Получение raw payload
    $rawPayload = file_get_contents('php://input');

    if (empty($rawPayload)) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'error' => 'Empty payload'
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }

    // Парсинг JSON
    $data = json_decode($rawPayload, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'error' => 'Invalid JSON: ' . json_last_error_msg()
        ], JSON_UNESCAPED_UNICODE);
        exit;
    }

    // Подключение к БД
    $database = new Database();
    $db = $database->getConnection();

    if (!$db) {
        throw new Exception('Database connection failed');
    }

    // Обработка вебхука
    $receiver = new GckReceiver($db, 'gck');
    $leadId = $receiver->process($data, $rawPayload);

    // Успешный ответ
    http_response_code(200);
    echo json_encode([
        'success' => true,
        'lead_id' => $leadId,
        'message' => 'Lead received and queued for processing'
    ], JSON_UNESCAPED_UNICODE);

} catch (Exception $e) {
    error_log('[GCK Webhook] Error: ' . $e->getMessage());

    http_response_code(500);
    echo json_encode([
        'success' => false,
        'error' => $e->getMessage()
    ], JSON_UNESCAPED_UNICODE);
}
