<?php
session_start();
require_once 'auth/session.php';
checkAuth();

$user_full_name = $_SESSION['full_name'] ?? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
$user_role = $_SESSION['role'] ?? 'user';
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=3.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - Domreal Admin</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* Better responsive support for browser zoom */
        * {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }
        .analytics-page {
            display: flex;
            height: 100vh;
            overflow: hidden;
            margin-left: 15.625rem; /* 250px –≤ rem –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è */
        }

        .analytics-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f8f9fa;
            width: 100%;
            box-sizing: border-box;
        }

        /* Sidebar fixed position */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 15.625rem; /* 250px */
            z-index: 1000;
            background: white;
            box-shadow: 0.125rem 0 0.5rem rgba(0,0,0,0.1);
            transition: width 0.3s ease;
        }

        /* Collapsed sidebar */
        .sidebar.collapsed {
            width: 4.375rem; /* 70px */
        }

        body.sidebar-collapsed .analytics-page {
            margin-left: 4.375rem; /* 70px */
        }

        body.sidebar-collapsed .analytics-content {
            transition: margin-left 0.3s ease;
        }

        /* Hide sidebar header logo */
        .sidebar-header {
            display: none;
        }

        .sidebar-logo {
            display: none;
        }

        /* Ensure toggle button is visible */
        .sidebar-toggle {
            padding: 0.9375rem; /* 15px */
            border-bottom: 0.0625rem solid #e0e0e0;
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 0.9375rem; /* 15px */
            left: 0.9375rem; /* 15px */
            z-index: 999;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 0.5rem; /* 8px */
            padding: 0.625rem 0.75rem; /* 10px 12px */
            cursor: pointer;
            box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.15);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 48rem) { /* 768px */
            .analytics-page {
                margin-left: 0;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        .analytics-header {
            background: white;
            padding: 0.9375rem 1.5625rem; /* 15px 25px */
            border-bottom: 0.0625rem solid #e0e0e0;
            flex-shrink: 0;
        }

        .analytics-header h1 {
            margin: 0 0 0.9375rem 0; /* 15px */
            font-size: 1.375rem; /* 22px */
            color: #333;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 9.375rem 9.375rem 12.5rem 12.5rem 1fr; /* 150px 150px 200px 200px flex */
            gap: 0.625rem; /* 10px */
            align-items: end;
        }

        .filter-group-combined {
            grid-column: 5 / -1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –æ—Å—Ç–∞–≤—à—É—é—Å—è —à–∏—Ä–∏–Ω—É */
        }

        .combined-filters-row {
            display: flex;
            gap: 0.75rem; /* 12px */
            align-items: center;
        }

        .crm-compact {
            width: 12.5rem; /* 200px - —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è CRM */
        }

        .toggle-filter-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            white-space: nowrap;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 2.5rem; /* 40px */
            height: 1.25rem; /* 20px */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 1.25rem; /* 20px */
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 0.875rem; /* 14px */
            width: 0.875rem; /* 14px */
            left: 0.1875rem; /* 3px */
            bottom: 0.1875rem; /* 3px */
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(1.25rem); /* 20px */
        }

        .toggle-label {
            font-size: 0.8125rem; /* 13px */
            color: #666;
        }

        @media (max-width: 75rem) { /* 1200px */
            .filters-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filter-group-combined {
                grid-column: 1 / -1;
            }

            .combined-filters-row {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 48rem) { /* 768px */
            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filter-group-combined {
                grid-column: 1;
            }

            .combined-filters-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .crm-compact {
                width: 100%;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.75rem; /* 12px */
            color: #666;
            margin-bottom: 0.25rem; /* 4px */
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.375rem 0.625rem; /* 6px 10px */
            border: 0.0625rem solid #ddd;
            border-radius: 0.25rem; /* 4px */
            font-size: 0.8125rem; /* 13px */
        }

        .filter-actions {
            display: flex;
            gap: 0.625rem; /* 10px */
        }

        .btn {
            padding: 0.375rem 1rem; /* 6px 16px */
            border: none;
            border-radius: 0.25rem; /* 4px */
            font-size: 0.8125rem; /* 13px */
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .analytics-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.9375rem 1.25rem; /* 15px 20px */
            width: 100%;
            box-sizing: border-box;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.9375rem; /* 15px */
            width: 100%;
            box-sizing: border-box;
        }

        .dashboard-grid .chart-container.full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 64rem) { /* 1024px */
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* KPI Cards */
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(11.25rem, 1fr)); /* 180px */
            gap: 0.75rem; /* 12px */
            margin-bottom: 0.9375rem; /* 15px */
            width: 100%;
        }

        .kpi-card {
            background: white;
            padding: 0.9375rem; /* 15px */
            border-radius: 0.375rem; /* 6px */
            box-shadow: 0 0.0625rem 0.1875rem rgba(0,0,0,0.1);
        }

        .kpi-card-title {
            font-size: 0.75rem; /* 12px */
            color: #666;
            margin-bottom: 0.5rem; /* 8px */
            text-align: center;
        }

        .kpi-card-value {
            font-size: 1.75rem; /* 28px */
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem; /* 4px */
            text-align: center;
        }

        .kpi-card-subtitle {
            font-size: 0.6875rem; /* 11px */
            color: #999;
            text-align: center;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            padding: 0.9375rem; /* 15px */
            border-radius: 0.375rem; /* 6px */
            box-shadow: 0 0.0625rem 0.1875rem rgba(0,0,0,0.1);
            margin-bottom: 0.9375rem; /* 15px */
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .chart-title {
            font-size: 1rem; /* 16px */
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem; /* 8px - —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
            text-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        .chart-title.centered {
            text-align: center;
            display: block;
            width: 100%;
        }

        .chart-criteria {
            background-color: #f8f9fa;
            border-left: 4px solid #2196F3;
            padding: 0.5rem 0.75rem; /* 8px 12px - —É–º–µ–Ω—å—à–µ–Ω */
            margin: -0.625rem 0 0.75rem 0; /* -10px 0 12px 0 - —É–º–µ–Ω—å—à–µ–Ω –Ω–∏–∂–Ω–∏–π */
            font-size: 0.75rem; /* 12px - —É–º–µ–Ω—å—à–µ–Ω */
            line-height: 1.5; /* —É–º–µ–Ω—å—à–µ–Ω */
        }

        .chart-criteria strong {
            color: #333;
            display: block;
            margin-bottom: 0.375rem; /* 6px - —É–º–µ–Ω—å—à–µ–Ω */
            text-align: center;
            font-size: 0.8125rem; /* 13px */
        }

        .chart-criteria-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.375rem 0.75rem; /* 6px 12px - —É–º–µ–Ω—å—à–µ–Ω */
        }

        .chart-criteria-grid.single-row {
            grid-template-columns: 1fr;
        }

        @media (max-width: 48rem) { /* 768px */
            .chart-criteria-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-criteria ul {
            margin: 0;
            padding-left: 1rem; /* 16px - —É–º–µ–Ω—å—à–µ–Ω */
            list-style-type: disc;
        }

        .chart-criteria li {
            margin: 0.125rem 0; /* 2px 0 - —É–º–µ–Ω—å—à–µ–Ω */
            color: #555;
            line-height: 1.4;
        }

        .chart-criteria em {
            color: #666;
            font-style: italic;
            display: block;
            margin-top: 0.625rem; /* 10px */
            padding-top: 0.625rem; /* 10px */
            border-top: 1px solid #dee2e6;
        }

        .chart-canvas {
            width: 100%;
            height: 25rem; /* 400px */
            min-height: 18.75rem; /* 300px */
        }

        .chart-canvas.small {
            height: 18.75rem; /* 300px */
            min-height: 15rem; /* 240px */
        }

        .chart-canvas.large {
            height: 31.25rem; /* 500px */
            min-height: 25rem; /* 400px */
        }

        /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –∏ –æ—Ü–µ–Ω–æ–∫ */
        #first-call-conversion-chart,
        #repeat-call-conversion-chart,
        #first-call-scores-chart,
        #repeat-call-scores-chart {
            overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë —á—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
        }


        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 3.125rem; /* 50px */
            height: 3.125rem; /* 50px */
            border: 0.25rem solid #f3f3f3;
            border-top: 0.25rem solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Multi-select */
        .multi-select-wrapper {
            position: relative;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 31.25rem; /* 500px */
            background: white;
            border: 0.0625rem solid #ddd;
            border-radius: 0.25rem; /* 4px */
            max-height: 25rem; /* 400px */
            display: none;
            flex-direction: column;
            z-index: 100;
            margin-top: 0.125rem; /* 2px */
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
        }

        .multi-select-dropdown.active {
            display: flex;
        }

        .multi-select-header {
            padding: 0.625rem; /* 10px */
            border-bottom: 0.0625rem solid #e5e5e5;
            display: flex;
            flex-direction: column;
            gap: 0.375rem; /* 6px */
            flex-shrink: 0;
        }

        .multi-select-search {
            flex: 1;
            padding: 0.375rem 0.625rem; /* 6px 10px */
            border: 0.0625rem solid #D0D0D0;
            border-radius: 0.1875rem; /* 3px */
            font-size: 0.8125rem; /* 13px */
            outline: none;
            box-sizing: border-box;
        }

        .multi-select-search:focus {
            border-color: #2196F3;
        }

        .multi-select-header-buttons {
            display: flex;
            gap: 0.375rem; /* 6px */
        }

        .multi-select-btn {
            padding: 0.3125rem 0.625rem; /* 5px 10px */
            background: #f5f5f5;
            border: none;
            border-radius: 0.1875rem; /* 3px */
            font-size: 0.75rem; /* 12px */
            color: #2196F3;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .multi-select-btn:hover {
            background: #E3F2FD;
        }

        .multi-select-btn:last-child {
            color: #666;
        }

        .multi-select-btn:last-child:hover {
            background: #FFEBEE;
            color: #f44336;
        }

        .multi-select-options {
            overflow-y: auto;
            max-height: 21.875rem; /* 350px */
            flex: 1;
        }

        .multi-select-option {
            padding: 0.5rem 0.75rem; /* 8px 12px */
            cursor: pointer;
            display: flex;
            align-items: flex-start;
        }

        .multi-select-option:hover {
            background: #f5f5f5;
        }

        .multi-select-option input {
            margin-right: 0.5rem; /* 8px */
            margin-top: 0.25rem; /* 4px - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º */
            flex-shrink: 0;
        }

        .multi-select-option label {
            flex: 1;
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
        }

        .multi-select-display {
            cursor: pointer;
            padding: 0.375rem 0.625rem; /* 6px 10px */
            border: 0.0625rem solid #ddd;
            border-radius: 0.25rem; /* 4px */
            background: white;
            min-height: 2rem; /* 32px */
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8125rem; /* 13px */
        }

        .multi-select-display::after {
            content: '‚ñº';
            font-size: 0.5625rem; /* 9px */
            color: #666;
        }

        /* Tooltip Styles */
        .chart-title.has-tooltip {
            cursor: help;
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted #999;
        }

        .chart-title.has-tooltip:hover {
            color: #2196F3;
        }

        .tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0.5rem;
            background: #ffffff;
            border: 2px solid #2196F3;
            border-radius: 0.5rem;
            padding: 1rem;
            min-width: 25rem;
            max-width: 50rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            font-size: 0.75rem;
            line-height: 1.5;
            text-align: left;
        }

        /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ tooltip –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        @media (max-width: 48rem) {
            .tooltip {
                left: 10%;
                transform: translateX(0);
                min-width: 80%;
            }
        }

        .tooltip.active {
            display: block;
        }

        .tooltip strong {
            color: #333;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
        }

        .tooltip p {
            margin: 0.5rem 0;
            color: #555;
        }

        .tooltip-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        @media (max-width: 48rem) {
            .tooltip-grid {
                grid-template-columns: 1fr;
            }
        }

        .tooltip ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.25rem;
            list-style-type: disc;
        }

        .tooltip li {
            margin: 0.25rem 0;
            color: #555;
        }

        /* ========================================
           –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è Analytics
           ======================================== */
        [data-theme="dark"] .analytics-page {
            background: var(--bg-color);
        }

        [data-theme="dark"] .analytics-content {
            background: var(--bg-color) !important;
        }

        [data-theme="dark"] .sidebar {
            background: var(--surface-color) !important;
            box-shadow: 0.125rem 0 0.5rem rgba(0,0,0,0.5);
        }

        [data-theme="dark"] .sidebar-toggle {
            border-bottom-color: var(--border-color) !important;
        }

        [data-theme="dark"] .analytics-header {
            background: var(--surface-color) !important;
            border-bottom-color: var(--border-color) !important;
        }

        [data-theme="dark"] .filters-grid {
            background: transparent !important;
        }

        [data-theme="dark"] .filter-group label {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .filter-group input,
        [data-theme="dark"] .filter-group select,
        [data-theme="dark"] .filters-grid input,
        [data-theme="dark"] .filters-grid select {
            background-color: #2c2c2e !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .filter-group button {
            background-color: #0066CC !important;
            color: white !important;
            border-color: #0066CC !important;
        }

        [data-theme="dark"] .filter-group button:hover {
            background-color: #0077DD !important;
        }

        [data-theme="dark"] button[type="button"] {
            background-color: #3a3a3c !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .kpi-card {
            background: var(--surface-color) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
            box-shadow: 0 0.0625rem 0.1875rem rgba(0,0,0,0.5) !important;
        }

        [data-theme="dark"] .kpi-card-title {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .kpi-card-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .kpi-card-subtitle {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .kpi-card h3 {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .kpi-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .charts-grid {
            background: transparent !important;
        }

        [data-theme="dark"] .chart-card {
            background: var(--surface-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .chart-container {
            background: var(--surface-color) !important;
            box-shadow: 0 0.0625rem 0.1875rem rgba(0,0,0,0.5) !important;
        }

        [data-theme="dark"] .chart-title {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .chart-criteria {
            background-color: #2c2c2e !important;
            border-left-color: var(--primary-color) !important;
        }

        [data-theme="dark"] .chart-criteria strong {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .chart-criteria ul {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .chart-criteria li {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .chart-card h3 {
            color: var(--text-color) !important;
            border-bottom-color: var(--border-color) !important;
        }

        [data-theme="dark"] .mobile-menu-btn {
            background: var(--primary-color) !important;
        }

        [data-theme="dark"] .tooltip {
            background: rgba(0, 0, 0, 0.95) !important;
            color: white !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .tooltip li {
            color: #ccc !important;
        }

        /* ECharts –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
        [data-theme="dark"] .chart-container {
            background: var(--surface-color) !important;
        }

        [data-theme="dark"] .chart-canvas,
        [data-theme="dark"] .chart-container canvas,
        [data-theme="dark"] div[id*="chart"] {
            background: transparent !important;
        }

        /* –£–±–∏—Ä–∞–µ–º —Å–ª–∏—à–∫–æ–º —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
        [data-theme="dark"] canvas {
            opacity: 0.95;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã –¥–ª—è Analytics */
        .theme-switcher-container {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 10001 !important;
        }

        #theme-switcher-btn {
            width: 44px !important;
            height: 44px !important;
            border: none !important;
            background: var(--surface-color) !important;
            color: var(--text-color) !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            box-shadow: var(--shadow-md) !important;
            border: 2px solid var(--border-color) !important;
        }

        #theme-switcher-btn:hover {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
            transform: scale(1.1) rotate(15deg) !important;
            box-shadow: var(--shadow-lg) !important;
        }

        #theme-switcher-btn:active {
            transform: scale(0.95) !important;
        }

        #theme-switcher-btn svg {
            width: 20px !important;
            height: 20px !important;
            transition: transform 0.3s ease !important;
            display: block !important;
        }

        [data-theme="dark"] #theme-switcher-btn {
            box-shadow: 0 2px 12px rgba(10, 132, 255, 0.3) !important;
        }

        [data-theme="dark"] #theme-switcher-btn:hover {
            box-shadow: 0 4px 20px rgba(10, 132, 255, 0.5) !important;
        }

    </style>
    <script src="assets/js/theme-switcher.js"></script>
</head>
<body>
    <!-- Theme Switcher Button -->
    <div class="theme-switcher-container">
        <button id="theme-switcher-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" title="–¢–µ–º–Ω–∞—è —Ç–µ–º–∞">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </div>

    <div class="analytics-page">
        <!-- Sidebar -->
        <?php include 'includes/sidebar.php'; ?>

        <!-- Main Content -->
        <div class="analytics-content">
            <!-- Header with Filters -->
            <div class="analytics-header">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="date_from">–î–∞—Ç–∞ —Å:</label>
                        <input type="date" id="date_from" value="<?php echo date('Y-m-d', strtotime('-7 days')); ?>">
                    </div>

                    <div class="filter-group">
                        <label for="date_to">–î–∞—Ç–∞ –ø–æ:</label>
                        <input type="date" id="date_to" value="<?php echo date('Y-m-d'); ?>">
                    </div>

                    <div class="filter-group">
                        <label>–û—Ç–¥–µ–ª—ã:</label>
                        <div class="multi-select-wrapper">
                            <div class="multi-select-display" id="departments-display">
                                <span>–í—Å–µ –æ—Ç–¥–µ–ª—ã</span>
                            </div>
                            <div class="multi-select-dropdown" id="departments-dropdown">
                                <div class="multi-select-header">
                                    <input type="text" class="multi-select-search" id="departments-search" placeholder="–ü–æ–∏—Å–∫">
                                    <div class="multi-select-header-buttons">
                                        <button type="button" class="multi-select-btn" id="departments-select-all">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                                        <button type="button" class="multi-select-btn" id="departments-clear">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="multi-select-options" id="departments-options">
                                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã:</label>
                        <div class="multi-select-wrapper">
                            <div class="multi-select-display" id="managers-display">
                                <span>–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                            </div>
                            <div class="multi-select-dropdown" id="managers-dropdown">
                                <div class="multi-select-header">
                                    <input type="text" class="multi-select-search" id="managers-search" placeholder="–ü–æ–∏—Å–∫">
                                    <div class="multi-select-header-buttons">
                                        <button type="button" class="multi-select-btn" id="managers-select-all">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                                        <button type="button" class="multi-select-btn" id="managers-clear">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="multi-select-options" id="managers-options">
                                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group filter-group-combined">
                        <label>CRM –≠—Ç–∞–ø:</label>
                        <div class="combined-filters-row">
                            <div class="multi-select-wrapper crm-compact">
                                <div class="multi-select-display" id="crm-stages-display">
                                    <span>–í—Å–µ —ç—Ç–∞–ø—ã</span>
                                </div>
                                <div class="multi-select-dropdown" id="crm-stages-dropdown">
                                    <div class="multi-select-header">
                                        <input type="text" class="multi-select-search" id="crm-stages-search" placeholder="–ü–æ–∏—Å–∫">
                                        <div class="multi-select-header-buttons">
                                            <button type="button" class="multi-select-btn" id="crm-stages-select-all">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                                            <button type="button" class="multi-select-btn" id="crm-stages-clear">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                        </div>
                                    </div>
                                    <div class="multi-select-options" id="crm-stages-options">
                                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                                    </div>
                                </div>
                            </div>

                            <div class="filter-actions">
                                <button class="btn btn-primary" id="apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                <button class="btn btn-secondary" id="reset-filters">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Body -->
            <div class="analytics-body">
                <!-- KPI Cards -->
                <div class="kpi-cards">
                    <div class="kpi-card">
                        <div class="kpi-card-title">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
                        <div class="kpi-card-value" id="kpi-total-calls">-</div>
                        <div class="kpi-card-subtitle">–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–ü–µ—Ä–≤—ã–µ –∑–≤–æ–Ω–∫–∏</div>
                        <div class="kpi-card-value" id="kpi-first-calls">-</div>
                        <div class="kpi-card-subtitle">–Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–≤–æ–Ω–∫–∏</div>
                        <div class="kpi-card-value" id="kpi-repeat-calls">-</div>
                        <div class="kpi-card-subtitle">—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–ù–µ—Å–æ—Å—Ç–æ—è–≤—à–∏–µ—Å—è –∑–≤–æ–Ω–∫–∏</div>
                        <div class="kpi-card-value" id="kpi-failed-calls">-</div>
                        <div class="kpi-card-subtitle">‚â§30 —Å–µ–∫—É–Ω–¥</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–ü–æ–∫–∞–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω</div>
                        <div class="kpi-card-value" id="kpi-successful-calls">-</div>
                        <div class="kpi-card-subtitle">–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–ü–æ–∫–∞–∑ —Å–æ—Å—Ç–æ—è–ª—Å—è</div>
                        <div class="kpi-card-value" id="kpi-conversion-rate">-</div>
                        <div class="kpi-card-subtitle">–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-card-title">–°—Ä–µ–¥–Ω–∏–π % —á–µ–∫–ª–∏—Å—Ç–∞</div>
                        <div class="kpi-card-value" id="kpi-avg-compliance">-</div>
                        <div class="kpi-card-subtitle">—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —à–∞–±–ª–æ–Ω–∞–º</div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- First Call Conversion Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="first-conversion-title">
                            üìû –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–µ—Ä–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤
                            <div class="tooltip" id="first-conversion-tooltip">
                                <strong>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–µ—Ä–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤:</strong>
                                <p>–ö–æ–Ω–≤–µ—Ä—Å–∏—è = (–£—Å–ø–µ—à–Ω—ã–µ –ø–µ—Ä–≤—ã–µ –∑–≤–æ–Ω–∫–∏ / –í—Å–µ–≥–æ –ø–µ—Ä–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤) √ó 100%</p>
                                <div>
                                    <strong style="color: #28a745;">‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>
                                    <ul>
                                        <li>–ù–∞–∑–Ω–∞—á–µ–Ω/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ø–æ–∫–∞–∑</li>
                                        <li>–ü–æ–∫–∞–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω</li>
                                        <li>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</li>
                                        <li>–ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å</li>
                                        <li>–ù–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</li>
                                        <li>–ë—Ä–æ–Ω—å / –°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="first-call-conversion-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Repeat Call Conversion Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="repeat-conversion-title">
                            üîÅ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤
                            <div class="tooltip" id="repeat-conversion-tooltip">
                                <strong>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤:</strong>
                                <p>–ö–æ–Ω–≤–µ—Ä—Å–∏—è = (–£—Å–ø–µ—à–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ / –í—Å–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤) √ó 100%</p>
                                <div>
                                    <strong style="color: #28a745;">‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong>
                                    <ul>
                                        <li>–ù–∞–∑–Ω–∞—á–µ–Ω/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ø–æ–∫–∞–∑</li>
                                        <li>–ü–æ–∫–∞–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω</li>
                                        <li>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</li>
                                        <li>–ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å</li>
                                        <li>–ù–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</li>
                                        <li>–ë—Ä–æ–Ω—å / –°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="repeat-call-conversion-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- First Call Scores Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="first-call-scores-title">
                            üìû –û—Ü–µ–Ω–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                            <div class="tooltip" id="first-call-scores-tooltip">
                                <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong>
                                <div class="tooltip-grid">
                                    <ul>
                                        <li>–ü—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –∏ –Ω–∞–∑–≤–∞–ª –∫–æ–º–ø–∞–Ω–∏—é</li>
                                        <li>–£–∑–Ω–∞–ª –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞</li>
                                        <li>–ü—Ä–µ–¥–ª–æ–∂–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</li>
                                    </ul>
                                    <ul>
                                        <li>–û–±—Ä–∞–±–æ—Ç–∞–ª –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è</li>
                                        <li>–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥</li>
                                        <li>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="first-call-scores-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Repeat Call Scores Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="repeat-call-scores-title">
                            üîÅ –û—Ü–µ–Ω–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                            <div class="tooltip" id="repeat-call-scores-tooltip">
                                <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏:</strong>
                                <div class="tooltip-grid">
                                    <ul>
                                        <li>–ü—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è –∏ –Ω–∞–ø–æ–º–Ω–∏–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç</li>
                                        <li>–ü—Ä–µ–¥–ª–æ–∂–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</li>
                                        <li>–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥</li>
                                    </ul>
                                    <ul>
                                        <li>–û–±—Ä–∞–±–æ—Ç–∞–ª –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è</li>
                                        <li>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="repeat-call-scores-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- First Call Results Distribution Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="first-call-results-title">
                            üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                            <div class="tooltip" id="first-call-results-tooltip">
                                <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong>
                                <div class="tooltip-grid">
                                    <ul>
                                        <li>‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω –ø–æ–∫–∞–∑</li>
                                        <li>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ø–æ–∫–∞–∑</li>
                                        <li>‚úÖ –ü–æ–∫–∞–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω</li>
                                        <li>‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã</li>
                                    </ul>
                                    <ul>
                                        <li>‚è≥ –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</li>
                                        <li>‚è∏Ô∏è –û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç</li>
                                        <li>üìµ –ù–µ–¥–æ–∑–≤–æ–Ω</li>
                                        <li>‚ùå –û—Ç–∫–∞–∑ / –Ω–µ —Ü–µ–ª–µ–≤–æ–π</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="first-call-results-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Repeat Call Results Distribution Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="repeat-call-results-title">
                            üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                            <div class="tooltip" id="repeat-call-results-tooltip">
                                <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong>
                                <div class="tooltip-grid">
                                    <ul>
                                        <li>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ø–æ–∫–∞–∑</li>
                                        <li>‚úÖ –ü–æ–∫–∞–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω</li>
                                        <li>üí∞ –ë—Ä–æ–Ω—å / –∑–∞–¥–∞—Ç–æ–∫</li>
                                        <li>üèÜ –°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞</li>
                                    </ul>
                                    <ul>
                                        <li>‚è≥ –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</li>
                                        <li>‚è∏Ô∏è –û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç</li>
                                        <li>üìµ –ù–µ–¥–æ–∑–≤–æ–Ω</li>
                                        <li>‚ùå –û—Ç–∫–∞–∑ / –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="repeat-call-results-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Funnel Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered">–í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏</div>
                        <div id="funnel-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Dynamics Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered">–î–∏–Ω–∞–º–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ –ø–æ –¥–Ω—è–º</div>
                        <div id="dynamics-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Communication Metrics Section -->

                    <!-- Interruptions Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="interruptions-title">
                            üìû –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
                            <div class="tooltip" id="interruptions-tooltip">
                                <strong>–ú–µ—Ç—Ä–∏–∫–∞ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏–π:</strong>
                                <p>–ü—Ä–æ—Ü–µ–Ω—Ç —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–∞—É–∑–∞ &lt;0.5 —Å–µ–∫)</p>
                                <div>
                                    <strong style="color: #28a745;">‚úÖ –•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</strong>
                                    <ul>
                                        <li>&lt;20% - –û—Ç–ª–∏—á–Ω–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–ª—É—à–∞–Ω–∏–µ</li>
                                        <li>20-30% - –•–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å</li>
                                    </ul>
                                    <strong style="color: #dc3545;">‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è:</strong>
                                    <ul>
                                        <li>30-50% - –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–±–∏–≤–∞–Ω–∏—è</li>
                                        <li>&gt;50% - –ö—Ä–∏—Ç–∏—á–Ω–æ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="interruptions-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Talk-to-Listen Ratio Chart -->
                    <div class="chart-container">
                        <div class="chart-title centered has-tooltip" id="talk-listen-title">
                            üó£Ô∏è –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ Talk-to-Listen
                            <div class="tooltip" id="talk-listen-tooltip">
                                <strong>–ú–µ—Ç—Ä–∏–∫–∞ Talk-to-Listen:</strong>
                                <p>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ—á–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ—á–∏ –∫–ª–∏–µ–Ω—Ç–∞</p>
                                <div>
                                    <strong style="color: #28a745;">‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</strong>
                                    <ul>
                                        <li>0.5-1.5 - –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥</li>
                                        <li>&lt;0.5 - –ú–µ–Ω–µ–¥–∂–µ—Ä –±–æ–ª—å—à–µ —Å–ª—É—à–∞–µ—Ç (–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è)</li>
                                    </ul>
                                    <strong style="color: #ffc107;">‚ö° –î–æ–º–∏–Ω–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞:</strong>
                                    <ul>
                                        <li>1.5-2.0 - –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç</li>
                                    </ul>
                                    <strong style="color: #dc3545;">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:</strong>
                                    <ul>
                                        <li>&gt;2.0 - –ú–æ–Ω–æ–ª–æ–≥ –≤–º–µ—Å—Ç–æ –¥–∏–∞–ª–æ–≥–∞</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="talk-listen-chart" class="chart-canvas large"></div>
                    </div>

                    <!-- Funnel By Manager Dashboard -->
                    <div class="chart-container full-width" style="margin-top: 20px;">
                        <div class="chart-title centered">
                            üéØ –í–æ—Ä–æ–Ω–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
                        </div>

                        <!-- Mode switcher -->
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary active" data-funnel-mode="managers">
                                    –ü–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-funnel-mode="departments">
                                    –ü–æ –æ—Ç–¥–µ–ª–∞–º
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-funnel-mode="detailed">
                                    –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
                                </button>
                            </div>
                        </div>

                        <!-- Dashboard content: Table (100% width) + Chart below -->

                        <!-- Table (full width with horizontal scroll) -->
                        <div id="funnel-table-container" style="width: 100%; overflow-x: auto; margin-bottom: 30px;">
                            <div class="alert alert-info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                        </div>

                        <!-- Chart (below table) -->
                        <div style="width: 100%; margin-top: 20px;">
                            <div id="funnel-by-manager-chart" class="chart-canvas large" style="width: 100%; height: 600px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="assets/js/sidebar.js"></script>
    <script src="assets/js/fetch_retry.js?v=<?php echo time(); ?>"></script>
    <script src="assets/js/analytics.js?v=<?php echo time(); ?>"></script>
    <script src="assets/js/conversion_charts_split.js?v=<?php echo time(); ?>"></script>
    <script src="assets/js/communication_charts.js?v=<?php echo time(); ?>"></script>
    <script src="assets/js/funnel_by_manager_chart.js?v=<?php echo time(); ?>"></script>
    <script src="assets/js/analytics-theme-handler.js?v=<?php echo time(); ?>"></script>

    <!-- Scroll to Top on Page Load -->
    <script>
        // –û–¢–ö–õ–Æ–ß–ê–ï–ú –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –í–°–ï–• –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        function scrollToTop() {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –í–°–ï —ç–ª–µ–º–µ–Ω—Ç—ã —Å overflow
            const scrollableElements = [
                '.analytics-body',
                '.analytics-content',
                '.analytics-page',
                'body',
                'html'
            ];

            scrollableElements.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el) {
                        console.log(`–ü—Ä–æ–∫—Ä—É—Ç–∫–∞ ${selector}, —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è:`, el.scrollTop);
                        el.scrollTop = 0;
                        if (el.scrollTo) {
                            el.scrollTo({ top: 0, behavior: 'auto' });
                        }
                    }
                });
            });

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º window
            window.scrollTo({ top: 0, behavior: 'auto' });
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;

            console.log('–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–∫—Ä—É—á–µ–Ω—ã –≤–≤–µ—Ä—Ö');
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –°–†–ê–ó–£ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ (—Å–∞–º–æ–µ —Ä–∞–Ω–Ω–µ–µ)
        scrollToTop();

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö');
            scrollToTop();
        });

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            console.log('window.load - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö');
            scrollToTop();
        });

        // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
        setTimeout(scrollToTop, 100);
        setTimeout(scrollToTop, 300);
        setTimeout(scrollToTop, 500);
        setTimeout(scrollToTop, 1000);
        setTimeout(scrollToTop, 1500);
        setTimeout(scrollToTop, 2000);

        // –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ 2.5 —Å–µ–∫
        setTimeout(() => {
            console.log('=== –§–ò–ù–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ===');
            const analyticsBody = document.querySelector('.analytics-body');
            const analyticsContent = document.querySelector('.analytics-content');
            const analyticsPage = document.querySelector('.analytics-page');

            console.log('.analytics-body scrollTop:', analyticsBody?.scrollTop);
            console.log('.analytics-body scrollHeight:', analyticsBody?.scrollHeight);
            console.log('.analytics-body clientHeight:', analyticsBody?.clientHeight);
            console.log('.analytics-content scrollTop:', analyticsContent?.scrollTop);
            console.log('.analytics-page scrollTop:', analyticsPage?.scrollTop);
            console.log('body scrollTop:', document.body.scrollTop);
            console.log('html scrollTop:', document.documentElement.scrollTop);
            console.log('window pageYOffset:', window.pageYOffset);
            console.log('window scrollY:', window.scrollY);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º getBoundingClientRect –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const firstCard = document.querySelector('.kpi-card');
            if (firstCard) {
                const rect = firstCard.getBoundingClientRect();
                console.log('–ü–µ—Ä–≤–∞—è KPI –∫–∞—Ä—Ç–æ—á–∫–∞ position:', rect.top, rect.left);
                console.log('–ü–µ—Ä–≤–∞—è KPI –∫–∞—Ä—Ç–æ—á–∫–∞ –≤–∏–¥–Ω–∞?', rect.top >= 0 && rect.top < window.innerHeight);
            }

            // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–æ - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
            if (analyticsBody?.scrollTop > 0 || window.scrollY > 0) {
                console.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–≤–µ—Ä—Ö');
                scrollToTop();
            } else {
                console.log('‚úÖ –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞–≤–µ—Ä—Ö—É!');
            }
        }, 2500);

        // MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã—Å–æ—Ç—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            const analyticsBody = document.querySelector('.analytics-body');
            if (analyticsBody) {
                const observer = new MutationObserver(function(mutations) {
                    // –ü—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ DOM - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö
                    scrollToTop();
                });

                observer.observe(analyticsBody, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style']
                });

                // –û—Ç–∫–ª—é—á–∞–µ–º observer —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    observer.disconnect();
                    console.log('MutationObserver –æ—Ç–∫–ª—é—á–µ–Ω');
                }, 3000);
            }
        });
    </script>

    <!-- Tooltip Management Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å tooltip'–∞–º–∏
            const tooltipTriggers = [
                {
                    title: document.getElementById('first-conversion-title'),
                    tooltip: document.getElementById('first-conversion-tooltip')
                },
                {
                    title: document.getElementById('repeat-conversion-title'),
                    tooltip: document.getElementById('repeat-conversion-tooltip')
                },
                {
                    title: document.getElementById('first-call-scores-title'),
                    tooltip: document.getElementById('first-call-scores-tooltip')
                },
                {
                    title: document.getElementById('repeat-call-scores-title'),
                    tooltip: document.getElementById('repeat-call-scores-tooltip')
                },
                {
                    title: document.getElementById('first-call-results-title'),
                    tooltip: document.getElementById('first-call-results-tooltip')
                },
                {
                    title: document.getElementById('repeat-call-results-title'),
                    tooltip: document.getElementById('repeat-call-results-tooltip')
                },
                {
                    title: document.getElementById('interruptions-title'),
                    tooltip: document.getElementById('interruptions-tooltip')
                },
                {
                    title: document.getElementById('talk-listen-title'),
                    tooltip: document.getElementById('talk-listen-tooltip')
                }
            ];

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tooltip
            tooltipTriggers.forEach(function(item) {
                if (item.title && item.tooltip) {
                    // –ü–æ–∫–∞–∑–∞—Ç—å tooltip –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    item.title.addEventListener('mouseenter', function() {
                        item.tooltip.classList.add('active');
                    });

                    // –°–∫—Ä—ã—Ç—å tooltip –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    item.title.addEventListener('mouseleave', function() {
                        item.tooltip.classList.remove('active');
                    });

                    // –û—Å—Ç–∞–≤–∏—Ç—å tooltip –≤–∏–¥–∏–º—ã–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–∞–º tooltip
                    item.tooltip.addEventListener('mouseenter', function() {
                        item.tooltip.classList.add('active');
                    });

                    // –°–∫—Ä—ã—Ç—å tooltip –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏ —Å —Å–∞–º–æ–≥–æ tooltip
                    item.tooltip.addEventListener('mouseleave', function() {
                        item.tooltip.classList.remove('active');
                    });
                }
            });

            // –°–∫—Ä—ã—Ç—å –≤—Å–µ tooltip'—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö –æ–±–ª–∞—Å—Ç–∏
            document.addEventListener('click', function(event) {
                const isTooltipClick = event.target.closest('.has-tooltip') || event.target.closest('.tooltip');
                if (!isTooltipClick) {
                    tooltipTriggers.forEach(function(item) {
                        if (item.tooltip) {
                            item.tooltip.classList.remove('active');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
